<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Aplikasi Manajemen Project Klien NextGen (Firebase)</title> <!-- Updated Title -->

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <!-- End Firebase SDK -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        /* CSS styles remain exactly the same as your previous "maximized" version */
        /* --- CSS Variables for Theming --- */
        :root {
            --bg-color: #f8f9fa; --text-color: #212529; --card-bg: #fff;
            --header-bg: #343a40; --header-text: #fff; --accent-color: #007bff;
            --border-color: #dee2e6; --input-border: #ced4da; --highlight-bg: #e9ecef;
            --danger-color: #dc3545; --warning-color: #ffc107; --success-color: #28a745;
            --info-color: #17a2b8; --revision-color: #6f42c1;
            --priority-high-bg: #f8d7da; --priority-high-text: #721c24;
            --priority-medium-bg: #fff3cd; --priority-medium-text: #856404;
            --priority-low-bg: #d4edda; --priority-low-text: #155724;
            --archived-row-bg: #e9ecef; --link-color: #007bff;
            --focus-ring-color: rgba(0, 123, 255, 0.25); --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1); --tag-bg: #e2e3e5; --tag-text: #495057;
            --selected-row-bg: color-mix(in srgb, var(--accent-color) 15%, transparent);
            --button-gap: 8px; --padding-base: 1rem;
        }
        body.dark-mode {
            --bg-color: #212529; --text-color: #e9ecef; --card-bg: #343a40;
            --header-bg: #212529; --header-text: #fff; --accent-color: #0d6efd;
            --border-color: #495057; --input-border: #6c757d; --highlight-bg: #495057;
            --danger-color: #dc3545; --warning-color: #ffc107; --success-color: #198754;
            --info-color: #0dcaf0; --revision-color: #a97be6;
            --priority-high-bg: #58151c; --priority-high-text: #f8d7da;
            --priority-medium-bg: #665100; --priority-medium-text: #fff3cd;
            --priority-low-bg: #0c3014; --priority-low-text: #d4edda;
            --archived-row-bg: #495057; --link-color: #0d6efd;
            --focus-ring-color: rgba(13, 110, 253, 0.35);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.2); --shadow-md: 0 4px 6px rgba(0,0,0,0.3);
            --tag-bg: #5a6268; --tag-text: #e9ecef;
            --selected-row-bg: color-mix(in srgb, var(--accent-color) 25%, transparent);
        }
        /* --- GENERAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; } html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; transition: background-color 0.3s, color 0.3s; font-size: 16px; }
        *:focus-visible { outline: 2px solid var(--accent-color); outline-offset: 2px; box-shadow: 0 0 0 3px var(--focus-ring-color); border-radius: 5px; }
        *:focus:not(:focus-visible) { outline: none; }
        button, input, select, textarea { font-family: inherit; font-size: 1rem; background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--input-border); border-radius: 5px; padding: 10px 15px; transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--focus-ring-color); outline: none; }
        input[type="checkbox"] { width: 1.1em; height: 1.1em; padding: 0; vertical-align: middle; margin-right: 5px; accent-color: var(--accent-color); }
        button { cursor: pointer; background-color: var(--accent-color); color: white; border: none; font-weight: 500; transition: background-color 0.2s ease, opacity 0.2s, box-shadow 0.2s; padding: 10px 20px; display: inline-flex; align-items: center; gap: var(--button-gap); border-radius: 5px; }
        button:hover { background-color: color-mix(in srgb, var(--accent-color), black 10%); box-shadow: var(--shadow-sm); } button:active { background-color: color-mix(in srgb, var(--accent-color), black 20%); }
        button.danger { background-color: var(--danger-color); } button.danger:hover { background-color: color-mix(in srgb, var(--danger-color), black 10%); } button.danger:active { background-color: color-mix(in srgb, var(--danger-color), black 20%); }
        button.warning { background-color: var(--warning-color); color: #333; } button.warning:hover { background-color: color-mix(in srgb, var(--warning-color), black 10%); } button.warning:active { background-color: color-mix(in srgb, var(--warning-color), black 20%); }
        button.secondary { background-color: #6c757d; } button.secondary:hover { background-color: color-mix(in srgb, #6c757d, black 10%); } button.secondary:active { background-color: color-mix(in srgb, #6c757d, black 20%); }
        button.revision { background-color: var(--revision-color); } button.revision:hover { background-color: color-mix(in srgb, var(--revision-color), black 10%); } button.revision:active { background-color: color-mix(in srgb, var(--revision-color), black 20%); }
        button.info { background-color: var(--info-color); color: white; } button.info:hover { background-color: color-mix(in srgb, var(--info-color), black 10%); } button.info:active { background-color: color-mix(in srgb, var(--info-color), black 20%); }
        button:disabled { cursor: not-allowed; opacity: 0.65; box-shadow: none; }
        /* --- HEADER & NAVBAR --- */
        header { background: var(--header-bg); color: var(--header-text); padding: calc(var(--padding-base)*0.8) calc(var(--padding-base)*1.5); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: var(--shadow-sm); }
        header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .header-controls { display: flex; align-items: center; gap: 15px; }
        #themeToggleBtn { font-size: 1.3rem; background: none; border: none; color: var(--header-text); cursor: pointer; padding: 5px; line-height: 1; }
        .nav-menu { display: flex; gap: 10px; }
        .nav-menu a { color: var(--header-text); text-decoration: none; font-weight: 500; padding: 8px 12px; border-radius: 5px; transition: background-color 0.2s ease; white-space: nowrap; }
        .nav-menu a:hover, .nav-menu a.active-link { background-color: rgba(255, 255, 255, 0.15); }
        .hamburger { display: none; font-size: 28px; cursor: pointer; padding: 5px; background: none; border: none; color: var(--header-text); }
        /* --- SECTIONS & MAIN --- */
        main { max-width: 1500px; margin: calc(var(--padding-base)*1.5) auto; padding: calc(var(--padding-base)*1.5); background-color: var(--card-bg); border-radius: 10px; box-shadow: var(--shadow-md); }
        section { display: none; padding-top: var(--padding-base); } section.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h2 { margin-bottom: calc(var(--padding-base)*1.25); color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: calc(var(--padding-base)*0.75); font-weight: 600; font-size: 1.6rem; }
        /* --- DASHBOARD & STATS --- */
        .dashboard-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: calc(var(--padding-base)*1.25); margin-bottom: calc(var(--padding-base)*1.75); }
        .stat-card { background: var(--card-bg); padding: calc(var(--padding-base)*1.25); border-radius: 8px; text-align: center; border: 1px solid var(--border-color); border-left: 5px solid var(--accent-color); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-sm); }
        .stat-card h3 { margin-bottom: 12px; font-size: 1rem; color: var(--text-color); opacity: 0.9; font-weight: 500; }
        .stat-card p { font-size: 2rem; font-weight: 600; color: var(--text-color); }
        .stat-card.pending { border-left-color: var(--warning-color); } .stat-card.in-progress { border-left-color: var(--info-color); } .stat-card.completed { border-left-color: var(--success-color); } .stat-card.delivered { border-left-color: var(--revision-color); }
        .recent-orders h3 { margin-bottom: var(--padding-base); font-size: 1.2rem; font-weight: 600;}
        /* --- FORM SECTION --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 calc(var(--padding-base)*1.25); }
        form label { display: block; margin: var(--padding-base) 0 6px; font-weight: 500; font-size: 0.95rem; }
        form input, form select, form textarea { width: 100%; margin-bottom: 8px; } .form-group { margin-bottom: var(--padding-base); } .form-group-full { grid-column: 1 / -1; }
        .error-message { color: var(--danger-color); font-size: 0.88rem; display: none; margin-top: 5px; }
        form input.invalid, form select.invalid, form textarea.invalid { border-color: var(--danger-color); box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.25); }
        form button[type="submit"] { width: auto; padding: 12px 30px; margin-top: var(--padding-base); }
        /* --- LIST PESANAN SECTION --- */
        .list-controls { background-color: var(--highlight-bg); padding: var(--padding-base); border-radius: 8px; margin-bottom: calc(var(--padding-base)*1.25); border: 1px solid var(--border-color); }
        .filter-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--padding-base); align-items: end; margin-bottom: var(--padding-base); }
        .filter-area label { font-size: 0.9rem; margin-bottom: 5px; display: block; font-weight: 500;}
        .filter-area input, .filter-area select { width: 100%; padding: 8px 12px; font-size: 0.95rem; }
        .date-range-filter { display: flex; gap: 15px; align-items: end; }
        .list-actions { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: var(--padding-base); margin-top: var(--padding-base); padding-top: var(--padding-base); border-top: 1px solid var(--border-color); }
        .list-actions > div { display: flex; align-items: center; gap: 10px; } .list-actions label { font-weight: 500; } .list-actions button { padding: 8px 18px; font-size: 0.9rem; gap: 6px; }
        /* Bulk Actions */
        #bulkActionsContainer { padding: 10px; background-color: var(--highlight-bg); border: 1px solid var(--border-color); border-radius: 6px; margin-top: var(--padding-base); display: none; flex-wrap: wrap; gap: 10px; align-items: center; }
        #bulkActionsContainer.visible { display: flex; } #bulkActionsContainer label { margin-right: 5px; font-weight: 500; font-size: 0.9rem;} #bulkActionsContainer select { padding: 6px 10px; font-size: 0.9rem; width: auto; margin-right: 5px; } #bulkActionsContainer button { font-size: 0.9rem; padding: 6px 12px; gap: 4px;}
        /* Table Styles */
        .table-container { overflow-x: auto; margin-top: var(--padding-base); border: 1px solid var(--border-color); border-radius: 8px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 0; }
        th.col-checkbox, td.col-checkbox { width: 45px; text-align: center; padding-left: 10px; padding-right: 10px; }
        th, td { border-bottom: 1px solid var(--border-color); padding: 12px 14px; text-align: left; vertical-align: top; }
        th { background-color: var(--highlight-bg); color: var(--text-color); font-weight: 600; cursor: pointer; position: sticky; top: 0; z-index: 2; white-space: nowrap; border-top: 1px solid var(--border-color); }
        th:first-child { border-top-left-radius: 8px; } th:last-child { border-top-right-radius: 8px; }
        td.col-price, th.col-price { text-align: right; } td.col-tags { white-space: normal; max-width: 200px; } td.col-link a { color: var(--link-color); text-decoration: none; word-break: break-all;} td.col-link a:hover { text-decoration: underline; } td.col-link .link-icon { font-size: 0.9em; margin-left: 4px; } td.col-notes { max-width: 250px; white-space: normal; }
        th.th-sorted { background-color: color-mix(in srgb, var(--highlight-bg), black 5%); } body.dark-mode th.th-sorted { background-color: color-mix(in srgb, var(--highlight-bg), white 5%); }
        th .sort-indicator { font-size: 0.9em; margin-left: 8px; display: inline-block; color: var(--text-color); opacity: 0.6; transition: opacity 0.2s; } th:hover .sort-indicator { opacity: 1; } th .sort-indicator.active { opacity: 1; font-weight: bold; }
        tbody tr { transition: background-color 0.15s ease; } tbody tr.selected { background-color: var(--selected-row-bg); } tbody tr:last-child td:first-child { border-bottom-left-radius: 8px; } tbody tr:last-child td:last-child { border-bottom-right-radius: 8px; } tbody tr:hover:not(.selected) { background-color: var(--highlight-bg); } tbody tr.archived { background-color: var(--archived-row-bg) !important; opacity: 0.7; font-style: italic; } tbody tr.archived:hover:not(.selected) { opacity: 0.8; }
        .deadline-soon { background-color: color-mix(in srgb, var(--priority-medium-bg) 70%, transparent) !important; } .deadline-past { background-color: color-mix(in srgb, var(--priority-high-bg) 70%, transparent) !important; }
        td[data-label="Deadline"] span { font-size: 0.85em; opacity: 0.9; } .status-select { width: auto; padding: 6px 10px; font-size: 0.9rem; border-radius: 5px; margin-left: 5px;}
        .action-buttons { white-space: nowrap; display: inline-flex; gap: 5px; } button.action-button { margin-right: 0; padding: 5px 8px; font-size: 0.8rem; gap: 4px; }
        .priority-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid transparent;}
        .priority-High { background-color: var(--priority-high-bg); color: var(--priority-high-text); border-color: color-mix(in srgb, var(--priority-high-text), transparent 50%); } .priority-Medium { background-color: var(--priority-medium-bg); color: var(--priority-medium-text); border-color: color-mix(in srgb, var(--priority-medium-text), transparent 50%);} .priority-Low { background-color: var(--priority-low-bg); color: var(--priority-low-text); border-color: color-mix(in srgb, var(--priority-low-text), transparent 50%);}
        .tag-badge { display: inline-block; background-color: var(--tag-bg); color: var(--tag-text); padding: 3px 8px; border-radius: 4px; font-size: 0.8rem; margin: 2px; white-space: nowrap; }
        /* Pagination */
        #paginationControls { display: flex; justify-content: space-between; align-items: center; padding: var(--padding-base) 0; margin-top: var(--padding-base); border-top: 1px solid var(--border-color); flex-wrap: wrap; gap: var(--padding-base); } #paginationControls .items-per-page { display: flex; align-items: center; gap: 8px; } #paginationControls label { font-size: 0.9rem; margin-right: 5px; font-weight: 500; } #paginationControls select { font-size: 0.9rem; padding: 5px 8px; width: auto; } #paginationControls .page-nav { display: flex; gap: 8px; } #paginationControls .page-nav button { font-size: 0.9rem; padding: 6px 12px; gap: 5px; } #paginationControls #pageInfo { font-size: 0.9rem; font-weight: 500; text-align: center; flex-grow: 1; }
        /* Reports */
        .report-filters { background-color: var(--highlight-bg); padding: var(--padding-base); border-radius: 8px; margin-bottom: calc(var(--padding-base)*1.25); border: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: var(--padding-base); align-items: end; } .report-filters label { font-size: 0.9rem; margin-bottom: 5px; display: block; font-weight: 500; } .report-filters select, .report-filters input { padding: 8px 12px; font-size: 0.95rem; } .report-filters .date-range-filter { display: flex; gap: 15px; align-items: end; }
        .report-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: calc(var(--padding-base)*1.25); } .report-box { background: var(--card-bg); padding: calc(var(--padding-base)*1.25); border-radius: 8px; border: 1px solid var(--border-color); display: flex; flex-direction: column; } .report-box h3 { margin-bottom: var(--padding-base); font-size: 1.2rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: calc(var(--padding-base)*0.5); } .report-box .report-content { flex-grow: 1; } .chart-container { position: relative; height: 300px; width: 100%; flex-shrink: 0; }
        #clientSummaryTableContainer { max-height: 350px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 5px; margin-top: 10px; } #clientSummaryTable th { position: sticky; top: 0; z-index: 1; cursor: pointer; background-color: var(--highlight-bg); } #clientSummaryTable td { padding: 8px 12px; font-size: 0.9rem; } #clientSummaryTable tr:last-child td { border-bottom: none; }
        #reportProjectValue ul { list-style: none; padding: 0; margin: 0;} #reportProjectValue li { margin-bottom: 8px; padding-left: 20px; position: relative; font-size: 0.95rem; } #reportProjectValue li span.status-color-dot { position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background-color: #ccc; border-radius: 50%; } #reportProjectValue li strong { float: right; font-weight: 600;} #reportProjectValue li.total-value { margin-top: var(--padding-base); padding-top: calc(var(--padding-base)*0.75); border-top: 1px solid var(--border-color); font-weight: bold; }
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(3px); animation: fadeIn 0.3s ease; } .modal-content { background-color: var(--card-bg); margin: 5% auto; padding: calc(var(--padding-base)*1.75); border: none; width: 90%; max-width: 850px; border-radius: 10px; position: relative; box-shadow: var(--shadow-md); animation: slideIn 0.4s ease; } @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } } .close-btn { color: var(--text-color); opacity: 0.6; position: absolute; top: calc(var(--padding-base)*0.75); right: var(--padding-base); font-size: 32px; font-weight: bold; cursor: pointer; transition: opacity 0.2s ease; line-height: 1; padding: 0 5px; background: none; border: none;} .close-btn:hover { opacity: 1; } #editForm .form-group { margin-bottom: var(--padding-base); } #editForm h2 { margin-bottom: calc(var(--padding-base)*1.25); } #editForm button { margin-top: 10px; margin-right: 10px; }
        /* Toast */
        #toastContainer { position: fixed; bottom: 25px; right: 25px; z-index: 1002; display: flex; flex-direction: column; gap: 12px; } .toast { padding: 15px 25px; border-radius: 8px; color: white; font-weight: 500; min-width: 280px; box-shadow: var(--shadow-md); opacity: 0; transform: translateX(100%); transition: opacity 0.4s ease, transform 0.4s cubic-bezier(0.215, 0.610, 0.355, 1); display: flex; align-items: center; gap: 10px;} .toast::before { font-family: "Segoe UI Symbol", sans-serif; font-size: 1.2em; line-height: 1; } .toast.success::before { content: '✔️'; } .toast.error::before { content: '❌'; } .toast.info::before { content: 'ℹ️'; } .toast.show { opacity: 1; transform: translateX(0); } .toast.success { background-color: var(--success-color); } .toast.error { background-color: var(--danger-color); } .toast.info { background-color: var(--info-color); }
        /* Utilities */
        .text-center { text-align: center; } .text-right { text-align: right; } .empty-message { text-align: center; padding: 40px 20px; color: var(--text-color); opacity: 0.7; font-style: italic; font-size: 1.1rem; } .empty-message::before { content: '🤷‍♀️'; display: block; font-size: 2.5rem; margin-bottom: 15px; opacity: 0.5; }
        /* Loading Indicator */
        #loadingIndicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0,0,0,0.7); color: white; padding: 20px 30px; border-radius: 8px; z-index: 2000; display: none; font-weight: bold; }
        #loadingIndicator.show { display: block; }
        /* --- RESPONSIVE --- */
        @media (max-width: 992px) { .form-grid { grid-template-columns: 1fr; gap: 0; } .modal-content { max-width: 600px; } .list-actions { flex-direction: column; align-items: stretch;} #paginationControls { flex-direction: column; align-items: stretch; text-align: center;} #paginationControls .page-nav { justify-content: center;} .report-filters { flex-direction: column; align-items: stretch; gap: 15px;} .report-filters .date-range-filter { flex-direction: column; gap: 15px; align-items: stretch; } .report-box[style*="grid-column: span 2"] { grid-column: span 1; } }
        @media (max-width: 768px) { body { font-size: 15px; } header { padding: 12px 15px; } header h1 { font-size: 1.1rem; } .header-controls { gap: 8px; } .nav-menu { display: none; flex-direction: column; background: var(--header-bg); position: absolute; top: 58px; /* Adjust dynamically? */ right: 10px; width: 200px; padding: 15px; box-shadow: var(--shadow-md); border-radius: 8px; border: 1px solid var(--border-color); border-top: none; } .nav-menu.show { display: flex; } .hamburger { display: block; } main { margin: 15px; padding: 15px; } h2 { font-size: 1.4rem; margin-bottom: 20px; } .filter-area { grid-template-columns: 1fr; gap: 15px; } .date-range-filter { flex-direction: column; gap: 15px; align-items: stretch; } .list-actions button { width: 100%; } /* Make export full width if needed */ .dashboard-stats { grid-template-columns: 1fr; gap: 15px; } .stat-card { padding: 20px; } .stat-card p { font-size: 1.8rem; } .modal-content { width: 95%; margin: 8% auto; padding: 20px; max-width: 95%; } th, td { padding: 10px 8px; font-size: 0.85rem;} th.col-checkbox, td.col-checkbox { padding-left: 8px; padding-right: 8px; width: 35px;} .table-container { border-radius: 6px; } th:first-child { border-top-left-radius: 6px; } th:last-child { border-top-right-radius: 6px; } tbody tr:last-child td:first-child { border-bottom-left-radius: 6px; } tbody tr:last-child td:last-child { border-bottom-right-radius: 6px; } table { min-width: 1100px; } #toastContainer { right: 15px; bottom: 15px; width: calc(100% - 30px); gap: 10px;} .toast { min-width: auto; padding: 12px 20px; } .report-container { grid-template-columns: 1fr; gap: 20px;} .chart-container { height: 280px; } button.action-button { padding: 8px 10px; } #bulkActionsContainer { flex-direction: column; align-items: stretch; } #bulkActionsContainer div { display: flex; width: 100%; } #bulkActionsContainer div select { flex-grow: 1; } #bulkActionsContainer button { width: 100%; justify-content: center; } }
    </style>
</head>
<body>
    <header>
        <h1>Manajemen Project NextGen</h1>
        <div class="header-controls">
            <button id="themeToggleBtn" title="Toggle Light/Dark Mode">☀️</button>
            <button class="hamburger" onclick="toggleMenu()" title="Toggle Menu" aria-label="Toggle Menu">☰</button>
            <nav class="nav-menu" id="navMenu">
                <a href="#" data-section="dashboardSection" onclick="showSection('dashboardSection', this)">📊 Dashboard</a>
                <a href="#" data-section="inputSection" onclick="showSection('inputSection', this)">➕ Input Pesanan</a>
                <a href="#" data-section="listSection" onclick="showSection('listSection', this)">📋 List Pesanan</a>
                <a href="#" data-section="reportSection" onclick="showSection('reportSection', this)">📈 Laporan</a>
            </nav>
        </div>
    </header>

    <main>
        <!-- Sections remain the same as previous version -->
        <section id="dashboardSection" class="active">
            <h2>Dashboard Utama</h2>
            <div class="dashboard-stats">
                <div class="stat-card pending"><h3>Pending</h3><p id="pendingCount">0</p></div>
                <div class="stat-card in-progress"><h3>In Progress</h3><p id="progressCount">0</p></div>
                <div class="stat-card completed"><h3>Completed</h3><p id="completedCount">0</p></div>
                <div class="stat-card delivered"><h3>Delivered</h3><p id="deliveredCount">0</p></div>
                 <div class="stat-card" style="border-left-color: var(--accent-color);"><h3>Total Nilai Aktif</h3><p id="totalValueActive">Rp 0</p></div>
            </div>
            <div class="recent-orders">
                <h3>⏳ 5 Pesanan Terbaru (Aktif)</h3>
                <div class="table-container">
                    <table>
                        <thead><tr><th scope="col">Klien</th><th scope="col">Project</th><th scope="col">Harga</th><th scope="col">Status</th><th scope="col">Prioritas</th></tr></thead>
                        <tbody id="recentOrdersTable"></tbody>
                    </table>
                </div>
                <p id="noRecentOrdersMsg" class="empty-message" style="display: none;">Belum ada pesanan aktif terbaru.</p>
            </div>
        </section>

        <section id="inputSection">
            <h2>Input Pesanan Baru</h2>
            <form id="orderForm" novalidate>
                <div class="form-grid">
                    <div class="form-group"> <label for="clientName">Nama Klien</label> <input type="text" id="clientName" placeholder="Masukkan nama klien" required aria-describedby="clientNameError" /> <div class="error-message" id="clientNameError"></div> </div>
                    <div class="form-group"> <label for="clientContact">Kontak Klien (Email/Telp)</label> <input type="text" id="clientContact" placeholder="Opsional: email@contoh.com / 08xxxx" /> </div>
                    <div class="form-group"> <label for="projectType">Jenis Project</label> <select id="projectType" required aria-describedby="projectTypeError"> <option value="">-- Pilih Jenis Project --</option> <option value="Logo">Logo</option> <option value="Website">Website</option> <option value="Cerpen">Cerpen</option> <option value="Poster">Poster</option> <option value="Aplikasi Mobile">Aplikasi Mobile</option> <option value="Video Animasi">Video Animasi</option> <option value="Lainnya">Lainnya</option> </select> <div class="error-message" id="projectTypeError"></div> </div>
                    <div class="form-group"> <label for="projectPrice">Harga Project (Rp)</label> <input type="number" id="projectPrice" placeholder="Contoh: 500000" min="0" step="1000" aria-describedby="projectPriceError" /> <div class="error-message" id="projectPriceError"></div> </div>
                    <div class="form-group"> <label for="orderDate">Tanggal Order</label> <input type="date" id="orderDate" required aria-describedby="orderDateError"/> <div class="error-message" id="orderDateError"></div> </div>
                    <div class="form-group"> <label for="deadline">Deadline</label> <input type="date" id="deadline" required aria-describedby="deadlineError"/> <div class="error-message" id="deadlineError"></div> </div>
                    <div class="form-group"> <label for="priority">Prioritas</label> <select id="priority" required aria-describedby="priorityError"> <option value="Medium">Sedang</option> <option value="High">Tinggi</option> <option value="Low">Rendah</option> </select> <div class="error-message" id="priorityError"></div> </div>
                    <div class="form-group"> <label for="attachmentLink">Link Lampiran/Referensi</label> <input type="url" id="attachmentLink" placeholder="Opsional: https://..." aria-describedby="attachmentLinkError"/> <div class="error-message" id="attachmentLinkError"></div> </div>
                    <div class="form-group form-group-full"> <label for="projectTags">Tags (Pisahkan dengan koma)</label> <input type="text" id="projectTags" placeholder="Opsional: Revisi Mayor, Desain Cetak, Prioritas Utama" /> </div>
                    <div class="form-group form-group-full"> <label for="notes">Catatan / Brief</label> <textarea id="notes" placeholder="Detail project, revisi, dll. Tips: Gunakan '- [ ]' atau '- [x]' untuk checklist." rows="5"></textarea> </div>
                </div>
                <button type="submit"><span>➕</span> Tambah Pesanan</button>
            </form>
        </section>

        <section id="listSection">
            <h2>List Pesanan</h2>
            <div class="list-controls">
                <div class="filter-area">
                    <div> <label for="searchInput">🔍 Cari</label> <input type="text" id="searchInput" placeholder="Klien / Project / Kontak / Tags..." > </div>
                    <div> <label for="statusFilter">🚦 Status</label> <select id="statusFilter" > <option value="">-- Semua Status --</option> <option value="Pending">Pending</option> <option value="In Progress">In Progress</option> <option value="Completed">Completed</option> <option value="Delivered">Delivered</option> </select> </div>
                    <div> <label for="priorityFilter">🚩 Prioritas</label> <select id="priorityFilter" > <option value="">-- Semua Prioritas --</option> <option value="High">Tinggi</option> <option value="Medium">Sedang</option> <option value="Low">Rendah</option> </select> </div>
                    <div> <label for="tagFilter">🏷️ Filter Tag</label> <input type="text" id="tagFilter" placeholder="Masukkan satu tag..." > </div>
                    <div class="date-range-filter"> <div> <label for="startDateFilter">🗓️ Dari Tgl Order</label> <input type="date" id="startDateFilter" > </div> <div> <label for="endDateFilter">🗓️ Sampai Tgl Order</label> <input type="date" id="endDateFilter" > </div> </div>
                </div>
                 <div class="list-actions"> <div> <label for="showArchived">Tampilkan Arsip:</label> <input type="checkbox" id="showArchived"> </div> <button onclick="exportToCSV()" title="Ekspor data yang tampil di tabel ke CSV"><span>📄</span> Ekspor ke CSV</button> </div>
            </div>
             <div id="bulkActionsContainer"> <div> <label for="bulkStatusChange">Ubah Status (<span id="selectedCount">0</span> terpilih):</label> <select id="bulkStatusChange" title="Pilih status baru untuk item aktif terpilih"> <option value="">-- Pilih Status --</option> <option value="Pending">Pending</option> <option value="In Progress">In Progress</option> <option value="Completed">Completed</option> <option value="Delivered">Delivered</option> </select> <button id="bulkChangeStatusBtn" class="secondary" disabled title="Terapkan perubahan status ke item aktif terpilih"><span>🔄</span> Terapkan</button> </div> <div> <button id="bulkArchiveBtn" class="warning" disabled title="Arsipkan item aktif terpilih"><span>📁</span> Arsipkan Terpilih</button> <button id="bulkDeleteBtn" class="danger" disabled title="Hapus permanen item arsip terpilih"><span>🗑️</span> Hapus Arsip Terpilih</button> </div> </div>
            <div class="table-container">
                <table>
                    <thead> <tr> <th scope="col" class="col-checkbox"><input type="checkbox" id="selectAllCheckbox" title="Pilih Semua di Halaman Ini"></th> <th scope="col" onclick="setSort('clientName')">Klien <span class="sort-indicator" data-col="clientName"></span></th> <th scope="col">Kontak</th> <th scope="col" onclick="setSort('projectType')">Project <span class="sort-indicator" data-col="projectType"></span></th> <th scope="col" onclick="setSort('projectPrice')" class="col-price">Harga <span class="sort-indicator" data-col="projectPrice"></span></th> <th scope="col" onclick="setSort('orderDate')">Order <span class="sort-indicator" data-col="orderDate"></span></th> <th scope="col" onclick="setSort('deadline')">Deadline <span class="sort-indicator" data-col="deadline"></span></th> <th scope="col" onclick="setSort('priority')">Prioritas <span class="sort-indicator" data-col="priority"></span></th> <th scope="col">Status</th> <th scope="col">Tags</th> <th scope="col">Link</th> <th scope="col">Catatan</th> <th scope="col">Aksi</th> </tr> </thead>
                    <tbody id="orderTable"></tbody>
                </table>
            </div>
            <p id="noOrdersMsg" class="empty-message" style="display: none;">Tidak ada pesanan yang cocok dengan filter Anda.</p>
             <div id="paginationControls"> <div class="items-per-page"> <label for="itemsPerPageSelect">Item per halaman:</label> <select id="itemsPerPageSelect" title="Jumlah item yang ditampilkan per halaman"> <option value="10">10</option> <option value="15">15</option> <option value="25">25</option> <option value="50">50</option> </select> </div> <div id="pageInfo">Halaman 1 dari 1</div> <div class="page-nav"> <button id="prevPageBtn" disabled title="Halaman Sebelumnya"><span>◀️</span> Sebelumnya</button> <button id="nextPageBtn" disabled title="Halaman Berikutnya"><span>▶️</span> Berikutnya</button> </div> </div>
        </section>

        <section id="reportSection">
             <h2>Laporan Visual (Pesanan Aktif)</h2>
             <div class="report-filters"> <div> <label for="reportProjectTypeFilter">Filter Jenis Project:</label> <select id="reportProjectTypeFilter" title="Filter laporan berdasarkan jenis project"> <option value="">-- Semua Jenis Project --</option> </select> </div> <div class="date-range-filter"> <div> <label for="reportStartDateFilter">Dari Tgl Order:</label> <input type="date" id="reportStartDateFilter" title="Filter laporan dari tanggal order ini"> </div> <div> <label for="reportEndDateFilter">Sampai Tgl Order:</label> <input type="date" id="reportEndDateFilter" title="Filter laporan sampai tanggal order ini"> </div> </div> <button id="resetReportFiltersBtn" class="secondary" title="Hapus filter laporan"><span>🔄</span> Reset Filter</button> </div>
             <div class="report-container"> <div class="report-box"> <h3>📊 Distribusi Status</h3> <div class="report-content"> <div class="chart-container"> <canvas id="statusChart"></canvas> </div> <div id="reportProjectStatus"></div> </div> </div> <div class="report-box"> <h3>🏗️ Jumlah per Jenis Project</h3> <div class="report-content"> <div class="chart-container"> <canvas id="projectTypeChart"></canvas> </div> <div id="reportProjectType"></div> </div> </div> <div class="report-box"> <h3>💰 Total Nilai per Status</h3> <div class="report-content"> <div id="reportProjectValue"></div> </div> </div> <div class="report-box"> <h3>👥 Ringkasan Klien (Top 10 by Value)</h3> <div class="report-content"> <div id="clientSummaryTableContainer"> <table id="clientSummaryTable"> <thead> <tr> <th scope="col" onclick="sortClientTable(0)" title="Urutkan berdasarkan Nama Klien">Klien</th> <th scope="col" onclick="sortClientTable(1)" title="Urutkan berdasarkan Jumlah Order">Jumlah</th> <th scope="col" onclick="sortClientTable(2)" title="Urutkan berdasarkan Total Nilai">Total Nilai</th> </tr> </thead> <tbody></tbody> </table> </div> </div> </div> <div class="report-box" style="grid-column: span 2;"> <h3>📈 Tren Order Masuk per Bulan</h3> <div class="report-content"> <div class="chart-container" style="height: 350px;"> <canvas id="trendChart"></canvas> </div> </div> </div> </div>
             <div class="report-box" style="margin-top: 25px;"> <h3>🔢 Total Keseluruhan (Sesuai Filter)</h3> <p><b>Total Pesanan Aktif:</b> <span id="reportTotalActiveOrders">0</span></p> <p><b>Total Nilai Aktif:</b> <span id="reportTotalActiveValue">Rp 0</span></p> <p><b>Total Pesanan Diarsipkan (Global):</b> <span id="reportTotalArchivedOrders">0</span></p> </div>
        </section>

        <!-- Edit Modal remains the same -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeEditModal()" title="Tutup" aria-label="Tutup">×</button>
                <h2>✏️ Edit Pesanan</h2>
                <form id="editForm" novalidate> <input type="hidden" id="editId"> <div class="form-grid"> <div class="form-group"> <label for="editClientName">Nama Klien</label> <input type="text" id="editClientName" required aria-describedby="editClientNameError"/> <div class="error-message" id="editClientNameError"></div> </div> <div class="form-group"> <label for="editClientContact">Kontak Klien (Email/Telp)</label> <input type="text" id="editClientContact" /> </div> <div class="form-group"> <label for="editProjectType">Jenis Project</label> <select id="editProjectType" required aria-describedby="editProjectTypeError"> <option value="">-- Pilih Jenis Project --</option> <option value="Logo">Logo</option> <option value="Website">Website</option> <option value="Cerpen">Cerpen</option> <option value="Poster">Poster</option> <option value="Aplikasi Mobile">Aplikasi Mobile</option> <option value="Video Animasi">Video Animasi</option> <option value="Lainnya">Lainnya</option> </select> <div class="error-message" id="editProjectTypeError"></div> </div> <div class="form-group"> <label for="editProjectPrice">Harga Project (Rp)</label> <input type="number" id="editProjectPrice" min="0" step="1000" aria-describedby="editProjectPriceError"/> <div class="error-message" id="editProjectPriceError"></div> </div> <div class="form-group"> <label for="editOrderDate">Tanggal Order</label> <input type="date" id="editOrderDate" required aria-describedby="editOrderDateError"/> <div class="error-message" id="editOrderDateError"></div> </div> <div class="form-group"> <label for="editDeadline">Deadline</label> <input type="date" id="editDeadline" required aria-describedby="editDeadlineError"/> <div class="error-message" id="editDeadlineError"></div> </div> <div class="form-group"> <label for="editPriority">Prioritas</label> <select id="editPriority" required aria-describedby="editPriorityError"> <option value="High">Tinggi</option> <option value="Medium">Sedang</option> <option value="Low">Rendah</option> </select> <div class="error-message" id="editPriorityError"></div> </div> <div class="form-group"> <label for="editStatus">Status</label> <select id="editStatus" required> <option value="Pending">Pending</option> <option value="In Progress">In Progress</option> <option value="Completed">Completed</option> <option value="Delivered">Delivered</option> </select> </div> <div class="form-group"> <label for="editAttachmentLink">Link Lampiran/Referensi</label> <input type="url" id="editAttachmentLink" aria-describedby="editAttachmentLinkError"/> <div class="error-message" id="editAttachmentLinkError"></div> </div> <div class="form-group"> <label for="editProjectTags">Tags (Pisahkan dengan koma)</label> <input type="text" id="editProjectTags" /> </div> <div class="form-group form-group-full"> <label for="editNotes">Catatan / Brief</label> <textarea id="editNotes" rows="5"></textarea> </div> </div> <button type="submit"><span>💾</span> Simpan Perubahan</button> <button type="button" class="secondary" onclick="closeEditModal()"><span>❌</span> Batal</button> </form>
            </div>
        </div>

    </main>

    <div id="toastContainer"></div>
    <div id="loadingIndicator">Memuat...</div> <!-- Added Loading Indicator -->

    <script>
    // --- Firebase Configuration ---
    // PASTE YOUR FIREBASE CONFIG OBJECT HERE
    const firebaseConfig = {
      apiKey: "AIzaSyDms1ruwFRJQ8x61-R9twm1s9YTgIAyhIs", // Replace with your actual config
      authDomain: "manajemen-project-3d7dc.firebaseapp.com",
      projectId: "manajemen-project-3d7dc",
      storageBucket: "manajemen-project-3d7dc.firebasestorage.app",
      messagingSenderId: "152522315633",
      appId: "1:152522315633:web:7e49284c953cbc0fd3c8d0",
      measurementId: "G-ZFP50GL935" // Optional
    };

    // --- Initialize Firebase ---
    let db; // Firestore database instance
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        console.log("Firebase Initialized Successfully");
    } catch (error) {
        console.error("Firebase Initialization Failed:", error);
        showToast("Gagal terhubung ke database. Cek konfigurasi Firebase.", "error", 10000);
        // Optionally disable features or show a persistent error message
    }

    // --- STATE & INITIALIZATION ---
    let orders = []; // Local cache of orders, updated by Firestore listener
    let currentSort = { column: 'orderDate', direction: 'desc' };
    let statusChartInstance = null; let projectTypeChartInstance = null; let trendChartInstance = null;
    let filterDebounceTimer = null; let currentPage = 1; let itemsPerPage = 15; let selectedOrderIds = new Set();
    let clientReportSort = { column: 2, direction: 'desc' };
    let firestoreListenerUnsubscribe = null; // To detach the listener if needed

    // --- UTILITIES ---
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);
    const showLoading = () => { $('#loadingIndicator')?.classList.add('show'); };
    const hideLoading = () => { $('#loadingIndicator')?.classList.remove('show'); };
    function debounce(func, delay = 350) { clearTimeout(filterDebounceTimer); filterDebounceTimer = setTimeout(func, delay); }
    function formatDate(dateString) { if (!dateString) return '-'; try { const date = new Date(dateString + 'T00:00:00'); if (isNaN(date.getTime())) return '-'; return date.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }); } catch (e) { console.error("Date Format Error:", dateString, e); return '-'; } }
    function formatCurrency(value) { const number = Number(value); if (isNaN(number)) return 'Rp -'; return number.toLocaleString('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
    function sanitizeUrl(url) { if (!url) return ''; url = url.trim(); if (!url) return ''; if (/^(https?|mailto|tel):/i.test(url)) return url; if (!/^[a-z]+:/i.test(url) && url.includes('.')) return 'http://' + url; return '#'; }
    function parseTags(tagString) { if (!tagString || typeof tagString !== 'string') return []; return tagString.split(',').map(tag => tag.trim()).filter(tag => tag !== '' && tag.length < 30); }
    function isValidUrl(string) { if (!string) return true; string = string.trim(); if (!string) return true; if (/^(https?|ftp|mailto|tel):/i.test(string)) { try { new URL(string); return true; } catch (_) { return false; } } if (!/^[a-z]+:/i.test(string) && string.includes('.') && string.length > 3) { try { new URL('http://' + string); return true; } catch (e) { return false; } } return false; }

    // --- THEME ---
    const themeToggleBtn = $('#themeToggleBtn'); const currentTheme = localStorage.getItem('theme');
    function applyTheme(theme) { if (theme === 'dark') { document.body.classList.add('dark-mode'); themeToggleBtn.textContent = '🌙'; themeToggleBtn.title = 'Switch to Light Mode'; localStorage.setItem('theme', 'dark'); } else { document.body.classList.remove('dark-mode'); themeToggleBtn.textContent = '☀️'; themeToggleBtn.title = 'Switch to Dark Mode'; localStorage.setItem('theme', 'light'); } if ($('#reportSection').classList.contains('active')) { generateReport(); } }
    themeToggleBtn.addEventListener('click', () => { const newTheme = document.body.classList.contains('dark-mode') ? 'light' : 'dark'; applyTheme(newTheme); });
    if (currentTheme) applyTheme(currentTheme); else if (window.matchMedia?.('(prefers-color-scheme: dark)')?.matches) applyTheme('dark'); else applyTheme('light');

    // --- TOAST NOTIFICATIONS ---
    const toastContainer = $('#toastContainer'); function showToast(message, type = 'info', duration = 3500) { const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.innerHTML = `<span>${message}</span>`; toastContainer.appendChild(toast); toast.offsetHeight; toast.classList.add('show'); setTimeout(() => { if (toast.parentElement) { toast.classList.remove('show'); toast.addEventListener('transitionend', () => toast.remove(), { once: true }); } }, duration); }

    // --- FORM VALIDATION ---
    function validateField(field) { const errorElement = $(`#${field.id}Error`); let isValid = true; field.classList.remove('invalid'); if (errorElement) errorElement.style.display = 'none'; const label = field.labels?.[0]?.textContent || field.id; const value = field.value.trim(); if (field.required && !value && field.tagName !== 'SELECT') { if (errorElement) errorElement.textContent = `${label} wajib diisi.`; isValid = false; } else if (field.required && field.tagName === 'SELECT' && !field.value) { if (errorElement) errorElement.textContent = `${label} wajib dipilih.`; isValid = false; } else if (field.type === 'date' && field.id.includes('deadline')) { const formPrefix = field.id.startsWith('edit') ? 'edit' : ''; const orderDateField = $(`#${formPrefix}orderDate`); if (orderDateField?.value && field.value && field.value < orderDateField.value) { if (errorElement) errorElement.textContent = 'Deadline tdk boleh sblm Tgl Order.'; isValid = false; } } else if (field.type === 'number' && value !== '' && field.min && parseFloat(value) < parseFloat(field.min)) { if (errorElement) errorElement.textContent = `${label} min ${field.min}.`; isValid = false; } else if (field.type === 'url' && value && !isValidUrl(value)) { if (errorElement) errorElement.textContent = `Format ${label} tdk valid.`; isValid = false; } if (!isValid) { field.classList.add('invalid'); if (errorElement) errorElement.style.display = 'block'; field.setAttribute('aria-invalid', 'true'); } else { field.removeAttribute('aria-invalid'); } return isValid; }
    function validateForm(formId) { let isFormValid = true; const form = $(`#${formId}`); const fields = form.querySelectorAll('[required], input[type="date"], input[type="number"], input[type="url"]'); fields.forEach(field => { if (field.required || field.value.trim() !== '') { if (!validateField(field)) isFormValid = false; } }); return isFormValid; }
    $$('#orderForm [required], #orderForm input[type="date"], #orderForm input[type="number"], #orderForm input[type="url"]').forEach(field => { field.addEventListener('input', () => validateField(field)); field.addEventListener('change', () => validateField(field)); });
    $$('#editForm [required], #editForm input[type="date"], #editForm input[type="number"], #editForm input[type="url"]').forEach(field => { field.addEventListener('input', () => validateField(field)); field.addEventListener('change', () => validateField(field)); });

    // --- DATA MANAGEMENT (Firestore) ---
    const ordersCollection = db ? db.collection("orders") : null;

    function loadDataFromFirestore() {
        if (!ordersCollection) {
            console.error("Firestore is not initialized. Cannot load data.");
            hideLoading();
            return;
        }
        showLoading();
        // Detach previous listener if exists
        if (firestoreListenerUnsubscribe) firestoreListenerUnsubscribe();

        firestoreListenerUnsubscribe = ordersCollection.onSnapshot(querySnapshot => {
            const newOrders = [];
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                newOrders.push({
                    firebaseId: doc.id, // Store Firestore document ID
                    id: data.id || doc.id, // Use original ID if exists, else Firestore ID
                    clientName: data.clientName || '',
                    clientContact: data.clientContact || '',
                    projectType: data.projectType || 'Lainnya',
                    projectPrice: Number(data.projectPrice) || 0,
                    orderDate: String(data.orderDate || ''),
                    deadline: String(data.deadline || ''),
                    priority: data.priority || 'Medium',
                    attachmentLink: data.attachmentLink || '',
                    projectTags: Array.isArray(data.projectTags) ? data.projectTags : [],
                    notes: data.notes || '',
                    status: data.status || 'Pending',
                    isArchived: data.isArchived === true,
                    // Ensure createdTimestamp exists, default if not (useful for sorting later)
                    // Firebase serverTimestamp is better but requires more setup
                    createdTimestamp: data.createdTimestamp || Date.now()
                });
            });

            // Sort by creation time descending (newest first) as default view maybe?
            // Or keep the sort state defined by `currentSort`
             // newOrders.sort((a, b) => b.createdTimestamp - a.createdTimestamp);

            orders = newOrders; // Replace local cache
            hideLoading();
            updateDashboard();
            populateReportProjectTypeFilter();
            applyFilterAndSort(); // Refresh the UI with new data
            if ($('#reportSection').classList.contains('active')) generateReport(); // Refresh report if visible

        }, error => {
            console.error("Error listening to Firestore:", error);
            showToast("Gagal memuat data realtime. Coba refresh.", "error", 5000);
            hideLoading();
        });
    }

    async function addOrderToFirestore(orderData) {
        if (!ordersCollection) return Promise.reject("Firestore not initialized.");
        showLoading();
        // Add a timestamp for potential sorting later
        const dataToSave = { ...orderData, createdTimestamp: firebase.firestore.FieldValue.serverTimestamp() };
        delete dataToSave.id; // Let Firestore generate ID
        delete dataToSave.firebaseId; // Ensure no firebaseId field is saved

        try {
            const docRef = await ordersCollection.add(dataToSave);
            console.log("Document written with ID: ", docRef.id);
            hideLoading();
            return docRef; // Resolve with the document reference
        } catch (error) {
            console.error("Error adding document: ", error);
            hideLoading();
            showToast("Gagal menambahkan pesanan ke database.", "error");
            return Promise.reject(error); // Propagate the error
        }
    }

    async function updateOrderInFirestore(firebaseId, dataToUpdate) {
        if (!ordersCollection) return Promise.reject("Firestore not initialized.");
        if (!firebaseId) return Promise.reject("Invalid Firebase ID for update.");
        showLoading();
        const docRef = ordersCollection.doc(firebaseId);
        // Remove firebaseId and original id if present in update data
        delete dataToUpdate.firebaseId;
        delete dataToUpdate.id;

        try {
            await docRef.update(dataToUpdate);
            console.log("Document updated: ", firebaseId);
            hideLoading();
            return true;
        } catch (error) {
            console.error("Error updating document: ", error);
            hideLoading();
            showToast("Gagal memperbarui pesanan di database.", "error");
            return Promise.reject(error);
        }
    }

    async function deleteOrderFromFirestore(firebaseId) {
        if (!ordersCollection) return Promise.reject("Firestore not initialized.");
        if (!firebaseId) return Promise.reject("Invalid Firebase ID for delete.");
        showLoading();
        const docRef = ordersCollection.doc(firebaseId);
        try {
            await docRef.delete();
            console.log("Document deleted: ", firebaseId);
            hideLoading();
            return true;
        } catch (error) {
            console.error("Error deleting document: ", error);
            hideLoading();
            showToast("Gagal menghapus pesanan dari database.", "error");
            return Promise.reject(error);
        }
    }

    // --- MODIFIED EVENT HANDLERS & ACTIONS ---

    $('#orderForm').addEventListener('submit', async function(e) { // Made async
        e.preventDefault(); if (!validateForm('orderForm')) { showToast("Harap perbaiki error form.", "error"); this.querySelector('.invalid')?.focus(); return; }
        const newOrderData = {
            // id: Date.now(), // Let Firestore handle ID generation
            clientName: $('#clientName').value.trim(), clientContact: $('#clientContact').value.trim(), projectType: $('#projectType').value,
            projectPrice: parseFloat($('#projectPrice').value) || 0, orderDate: $('#orderDate').value, deadline: $('#deadline').value, priority: $('#priority').value,
            attachmentLink: $('#attachmentLink').value.trim(), projectTags: parseTags($('#projectTags').value), notes: $('#notes').value.trim(), status: "Pending", isArchived: false
        };

        try {
            await addOrderToFirestore(newOrderData);
            this.reset();
            $$('#orderForm .error-message').forEach(el => el.style.display = 'none'); $$('#orderForm .invalid').forEach(el => el.classList.remove('invalid'));
            showToast("Pesanan berhasil ditambahkan!", "success");
            currentPage = 1; // Reset page for list view
            // showSection('listSection'); // Let onSnapshot handle UI update and switch
        } catch (error) {
            // Error toast shown in addOrderToFirestore
        }
    });

    async function updateStatus(originalId, newStatus) { // Use original ID to find Firestore ID
        const order = orders.find(o => o.id === originalId);
        if (order && order.firebaseId) {
            try {
                await updateOrderInFirestore(order.firebaseId, { status: newStatus });
                showToast("Status diperbarui.", "info");
                // No applyFilterAndSort() needed here, listener will update UI
            } catch (error) { /* Error handled in update function */ }
        } else {
            console.error("Order or Firebase ID not found for ID:", originalId);
            showToast("Gagal menemukan pesanan untuk update status.", "error");
        }
    }

    async function archiveOrder(originalId) {
        const order = orders.find(o => o.id === originalId);
        if (order && order.firebaseId) {
            if (confirm(`Arsipkan pesanan "${order.clientName}"?`)) {
                try {
                    await updateOrderInFirestore(order.firebaseId, { isArchived: true });
                    showToast(`Pesanan "${order.clientName}" diarsipkan.`, "info");
                } catch (error) { /* Handled */ }
            }
        } else { console.error("Order/Firebase ID not found:", originalId); showToast("Gagal menemukan pesanan untuk diarsipkan.", "error"); }
    }

    async function unarchiveOrder(originalId) {
        const order = orders.find(o => o.id === originalId);
        if (order && order.firebaseId) {
            try {
                await updateOrderInFirestore(order.firebaseId, { isArchived: false });
                showToast(`Pesanan "${order.clientName}" dipulihkan.`, "info");
            } catch (error) { /* Handled */ }
        } else { console.error("Order/Firebase ID not found:", originalId); showToast("Gagal menemukan pesanan untuk dipulihkan.", "error"); }
    }

    async function deleteOrderPermanently(originalId) {
        const order = orders.find(o => o.id === originalId);
        if (order && order.firebaseId) {
            if (confirm(`HAPUS PERMANEN pesanan "${order.clientName}"? Tidak bisa dibatalkan.`)) {
                try {
                    await deleteOrderFromFirestore(order.firebaseId);
                    showToast("Pesanan dihapus permanen.", "success");
                    selectedOrderIds.delete(originalId); // Remove from selection if deleted
                    updateBulkActionUI();
                } catch (error) { /* Handled */ }
            }
        } else { console.error("Order/Firebase ID not found:", originalId); showToast("Gagal menemukan pesanan untuk dihapus.", "error"); }
    }

    async function requestRevision(originalId) {
        const order = orders.find(o => o.id === originalId);
        if (order && order.firebaseId && order.status === 'Completed' && !order.isArchived) {
            if (confirm(`Kembalikan status pesanan "${order.clientName}" ke 'In Progress' untuk revisi?`)) {
                const timestamp = new Date().toLocaleString('id-ID');
                const updatedNotes = (order.notes || '') + `\n\n-- Revisi diminta pada ${timestamp} --`;
                try {
                    await updateOrderInFirestore(order.firebaseId, { status: 'In Progress', notes: updatedNotes });
                    showToast(`Pesanan "${order.clientName}" dikembalikan ke In Progress.`, "success");
                } catch (error) { /* Handled */ }
            }
        } else { showToast("Revisi hanya bisa untuk status 'Completed' yg belum diarsip.", "warning"); }
    }

    editForm.addEventListener("submit", async function(e) { // Made async
        e.preventDefault(); if (!validateForm('editForm')) { showToast("Perbaiki error form edit.", "error"); this.querySelector('.invalid')?.focus(); return; }
        const originalId = parseInt($('#editId').value, 10);
        const order = orders.find(o => o.id === originalId);

        if (order && order.firebaseId) {
            const updatedData = {
                clientName: $('#editClientName').value.trim(), clientContact: $('#editClientContact').value.trim(), projectType: $('#editProjectType').value,
                projectPrice: parseFloat($('#editProjectPrice').value) || 0, orderDate: $('#editOrderDate').value, deadline: $('#editDeadline').value, priority: $('#editPriority').value,
                status: $('#editStatus').value, attachmentLink: $('#editAttachmentLink').value.trim(), projectTags: parseTags($('#editProjectTags').value), notes: $('#editNotes').value.trim(),
                // Do not update isArchived status from edit form
            };
            try {
                await updateOrderInFirestore(order.firebaseId, updatedData);
                closeEditModal();
                showToast("Pesanan berhasil diperbarui!", "success");
            } catch (error) { /* Handled */ }
        } else { showToast("Gagal memperbarui, pesanan tidak ditemukan.", "error"); }
    });

    // --- FILTER, SORT, & PAGINATION ---
    // (Logic remains the same, operates on the local `orders` cache populated by Firestore listener)
    $('#searchInput').addEventListener('input', () => debounce(resetAndFilter)); $('#statusFilter').addEventListener('change', resetAndFilter); $('#priorityFilter').addEventListener('change', resetAndFilter); $('#tagFilter').addEventListener('input', () => debounce(resetAndFilter)); $('#startDateFilter').addEventListener('change', resetAndFilter); $('#endDateFilter').addEventListener('change', resetAndFilter); $('#showArchived').addEventListener('change', resetAndFilter);
    $('#itemsPerPageSelect').addEventListener('change', (e) => { itemsPerPage = parseInt(e.target.value, 10); localStorage.setItem('itemsPerPage', itemsPerPage); resetAndFilter(); });
    $('#prevPageBtn').addEventListener('click', () => { if (currentPage > 1) { currentPage--; applyFilterAndSort(); } }); $('#nextPageBtn').addEventListener('click', () => { const totalItems = filterOrders().length; const totalPages = Math.ceil(totalItems / itemsPerPage); if (currentPage < totalPages) { currentPage++; applyFilterAndSort(); } });
    function resetAndFilter() { currentPage = 1; applyFilterAndSort(); }
    function filterOrders() { const searchValue = $('#searchInput').value.toLowerCase(); const statusValue = $('#statusFilter').value; const priorityValue = $('#priorityFilter').value; const tagValue = $('#tagFilter').value.toLowerCase().trim(); const showArchived = $('#showArchived').checked; const startDateValue = $('#startDateFilter').value; const endDateValue = $('#endDateFilter').value; return orders.filter(order => { const isOrderArchived = order.isArchived === true; if (showArchived !== isOrderArchived) return false; const matchStatus = !statusValue || order.status === statusValue; const matchPriority = !priorityValue || order.priority === priorityValue; const matchTag = !tagValue || (order.projectTags && order.projectTags.some(tag => tag.toLowerCase().includes(tagValue))); const matchSearch = !searchValue || ( order.clientName.toLowerCase().includes(searchValue) || (order.clientContact && order.clientContact.toLowerCase().includes(searchValue)) || order.projectType.toLowerCase().includes(searchValue) || (order.notes && order.notes.toLowerCase().includes(searchValue)) || (order.projectTags && order.projectTags.some(tag => tag.toLowerCase().includes(searchValue))) ); let matchDate = true; if (startDateValue && order.orderDate < startDateValue) matchDate = false; if (endDateValue && order.orderDate > endDateValue) matchDate = false; return matchStatus && matchPriority && matchTag && matchSearch && matchDate; }); }
    function applyFilterAndSort() { const filtered = filterOrders(); const priorityOrder = { High: 3, Medium: 2, Low: 1 }; filtered.sort((a, b) => { const col = currentSort.column; const dir = currentSort.direction === 'asc' ? 1 : -1; let valA = a[col]; let valB = b[col]; if (col === 'priority') { valA = priorityOrder[valA] || 0; valB = priorityOrder[valB] || 0; } else if (col === 'projectPrice') { valA = Number(valA) || 0; valB = Number(valB) || 0; } else if (col === 'orderDate' || col === 'deadline') { valA = valA || ''; valB = valB || ''; } else { valA = String(valA || '').toLowerCase(); valB = String(valB || '').toLowerCase(); } if (valA < valB) return -1 * dir; if (valA > valB) return 1 * dir; /* Secondary sort by timestamp or ID if primary is equal */ const tsA = a.createdTimestamp || a.id || 0; const tsB = b.createdTimestamp || b.id || 0; return tsB - tsA; }); const totalItems = filtered.length; const totalPages = Math.ceil(totalItems / itemsPerPage) || 1; currentPage = Math.max(1, Math.min(currentPage, totalPages)); const startIndex = (currentPage - 1) * itemsPerPage; const endIndex = startIndex + itemsPerPage; const paginatedItems = filtered.slice(startIndex, endIndex); updateSortIndicators(); renderTable(paginatedItems); renderPaginationControls(currentPage, totalPages, totalItems); updateBulkActionUI(); }
    function setSort(column) { if (currentSort.column === column) currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc'; else { currentSort.column = column; currentSort.direction = 'asc'; } currentPage = 1; applyFilterAndSort(); }
    function updateSortIndicators() { $$('th.th-sorted').forEach(th => th.classList.remove('th-sorted')); $$('th .sort-indicator').forEach(indicator => { indicator.textContent = ''; indicator.classList.remove('active'); }); const currentTh = $(`th[onclick*="setSort('${currentSort.column}')"]`); if (currentTh) { currentTh.classList.add('th-sorted'); const indicator = currentTh.querySelector('.sort-indicator'); if (indicator) { indicator.textContent = currentSort.direction === 'asc' ? ' ▲' : ' ▼'; indicator.classList.add('active'); } } }
    function renderPaginationControls(page, totalPages, totalItems) { const pageInfo = $('#pageInfo'); const prevBtn = $('#prevPageBtn'); const nextBtn = $('#nextPageBtn'); if (totalItems === 0) pageInfo.textContent = "Tidak ada data"; else { const startItem = (page - 1) * itemsPerPage + 1; const endItem = Math.min(startItem + itemsPerPage - 1, totalItems); pageInfo.textContent = `Menampilkan ${startItem}-${endItem} dari ${totalItems} | Hal ${page} dari ${totalPages}`; } prevBtn.disabled = page <= 1; nextBtn.disabled = page >= totalPages; $('#paginationControls').style.display = totalItems > 0 ? 'flex' : 'none'; }

    // --- RENDERING ---
    // (renderTable logic remains mostly the same, uses local `orders` cache)
    function renderTable(ordersToRender) { const tbody = $('#orderTable'); const noOrdersMsg = $('#noOrdersMsg'); tbody.innerHTML = ""; const selectAllCheckbox = $('#selectAllCheckbox'); if (selectAllCheckbox) selectAllCheckbox.checked = false; if (ordersToRender.length === 0) { noOrdersMsg.style.display = 'block'; tbody.closest('table').style.display = 'none'; updateBulkActionUI(); return; } noOrdersMsg.style.display = 'none'; tbody.closest('table').style.display = ''; const today = new Date(); today.setHours(0,0,0,0); const fragment = document.createDocumentFragment(); ordersToRender.forEach(order => { const tr = document.createElement("tr"); tr.dataset.orderId = order.id; if (order.isArchived) tr.classList.add('archived'); if (selectedOrderIds.has(order.id)) tr.classList.add('selected'); let deadlineText = formatDate(order.deadline); let deadlineClass = ''; if (order.deadline && !order.isArchived && order.status !== "Completed" && order.status !== "Delivered") { const deadlineDate = new Date(order.deadline + 'T00:00:00'); if (!isNaN(deadlineDate.getTime())) { deadlineDate.setHours(0,0,0,0); const diffTime = deadlineDate - today; const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (diffDays < 0) { deadlineText += ` <span style="font-weight: bold;">(Lewat ${Math.abs(diffDays)} hr)</span>`; deadlineClass = 'deadline-past'; } else if (diffDays <= 3) { deadlineText += ` <span style="font-weight: bold;">(${diffDays} hr lagi)</span>`; deadlineClass = 'deadline-soon'; } else { deadlineText += ` <span>(${diffDays} hr lagi)</span>`; } if (deadlineClass) tr.classList.add(deadlineClass); } } const priorityBadge = `<span class="priority-badge priority-${order.priority}">${order.priority}</span>`; const tagsHtml = (order.projectTags && order.projectTags.length > 0) ? order.projectTags.map(tag => `<span class="tag-badge" title="${tag}">${tag.length > 15 ? tag.substring(0, 13)+'...' : tag}</span>`).join('') : '-'; const linkHtml = order.attachmentLink ? `<a href="${sanitizeUrl(order.attachmentLink)}" target="_blank" rel="noopener noreferrer" title="${order.attachmentLink}">Link <span class="link-icon">🔗</span></a>` : '-'; let actionButtonsHtml = ''; if (order.isArchived) { actionButtonsHtml = `<button class="secondary action-button" onclick="unarchiveOrder(${order.id})" title="Pulihkan"><span>⤴️</span></button> <button class="danger action-button" onclick="deleteOrderPermanently(${order.id})" title="Hapus Permanen"><span>🗑️</span></button>`; } else if (order.status === 'Completed') { actionButtonsHtml = `<button class="revision action-button" onclick="requestRevision(${order.id})" title="Minta Revisi"><span>🔄</span></button> <button class="warning action-button" onclick="archiveOrder(${order.id})" title="Arsipkan"><span>📁</span></button>`; } else if (order.status === 'Delivered') { actionButtonsHtml = `<button class="warning action-button" onclick="archiveOrder(${order.id})" title="Arsipkan"><span>📁</span></button>`; } else { actionButtonsHtml = `<button class="secondary action-button" onclick="openEditModal(${order.id})" title="Edit"><span>✏️</span></button> <button class="info action-button" onclick="duplicateOrder(${order.id})" title="Duplikasi"><span>➕</span></button> <button class="warning action-button" onclick="archiveOrder(${order.id})" title="Arsipkan"><span>📁</span></button>`; } const notesDisplay = (order.notes || '-').substring(0, 40); const notesEllipsis = order.notes && order.notes.length > 40 ? '...' : ''; const notesTitle = order.notes || 'Tidak ada catatan'; const contactDisplay = (order.clientContact || '-').substring(0, 20); const contactEllipsis = order.clientContact && order.clientContact.length > 20 ? '...' : ''; const contactTitle = order.clientContact || 'Tidak ada kontak'; tr.innerHTML = `<td class="col-checkbox"><input type="checkbox" class="row-checkbox" data-id="${order.id}" ${selectedOrderIds.has(order.id) ? 'checked' : ''} aria-label="Pilih ${order.clientName}"></td> <td data-label="Klien">${order.clientName}</td> <td data-label="Kontak" title="${contactTitle}">${contactDisplay}${contactEllipsis}</td> <td data-label="Project">${order.projectType}</td> <td data-label="Harga" class="col-price">${formatCurrency(order.projectPrice)}</td> <td data-label="Order">${formatDate(order.orderDate)}</td> <td data-label="Deadline">${deadlineText}</td> <td data-label="Prioritas" class="text-center">${priorityBadge}</td> <td data-label="Status"> <select class="status-select" onchange="updateStatus(${order.id}, this.value)" ${order.isArchived || order.status === 'Delivered' ? 'disabled' : ''} title="Ubah Status Pesanan"> <option value="Pending" ${order.status === "Pending" ? "selected" : ""}>Pending</option> <option value="In Progress" ${order.status === "In Progress" ? "selected" : ""}>In Progress</option> <option value="Completed" ${order.status === "Completed" ? "selected" : ""}>Completed</option> <option value="Delivered" ${order.status === "Delivered" ? "selected" : ""}>Delivered</option> </select> </td> <td data-label="Tags" class="col-tags">${tagsHtml}</td> <td data-label="Link" class="col-link">${linkHtml}</td> <td data-label="Catatan" class="col-notes" title="${notesTitle}">${notesDisplay}${notesEllipsis}</td> <td data-label="Aksi" class="action-buttons">${actionButtonsHtml}</td> `; fragment.appendChild(tr); }); tbody.appendChild(fragment); addCheckboxListeners(); }

    // --- BULK ACTIONS (Firestore Based) ---
    function addCheckboxListeners() { $$('.row-checkbox').forEach(checkbox => { checkbox.addEventListener('change', (e) => { const id = parseInt(e.target.dataset.id, 10); const tr = e.target.closest('tr'); if (e.target.checked) { selectedOrderIds.add(id); tr?.classList.add('selected'); } else { selectedOrderIds.delete(id); tr?.classList.remove('selected'); } updateBulkActionUI(); }); }); }
    $('#selectAllCheckbox')?.addEventListener('change', (e) => { const isChecked = e.target.checked; $$('.row-checkbox').forEach(checkbox => { const id = parseInt(checkbox.dataset.id, 10); const tr = checkbox.closest('tr'); checkbox.checked = isChecked; if (isChecked) { selectedOrderIds.add(id); tr?.classList.add('selected'); } else { selectedOrderIds.delete(id); tr?.classList.remove('selected'); } }); updateBulkActionUI(); });
    function updateBulkActionUI() { const count = selectedOrderIds.size; const container = $('#bulkActionsContainer'); const countSpan = $('#selectedCount'); const changeStatusBtn = $('#bulkChangeStatusBtn'); const archiveBtn = $('#bulkArchiveBtn'); const deleteBtn = $('#bulkDeleteBtn'); const statusSelect = $('#bulkStatusChange'); if (!container || !countSpan || !changeStatusBtn || !archiveBtn || !deleteBtn || !statusSelect) return; if (count > 0) { container.classList.add('visible'); countSpan.textContent = count; let hasActive = false; let hasArchived = false; selectedOrderIds.forEach(id => { const order = orders.find(o => o.id === id); if (order) { if (order.isArchived) hasArchived = true; else hasActive = true; } }); const currentViewIsArchived = $('#showArchived').checked; const canArchive = hasActive && !hasArchived; const canDelete = hasArchived && !hasActive && currentViewIsArchived; changeStatusBtn.disabled = !statusSelect.value || !canArchive; archiveBtn.disabled = !canArchive; deleteBtn.disabled = !canDelete; } else { container.classList.remove('visible'); countSpan.textContent = 0; changeStatusBtn.disabled = true; archiveBtn.disabled = true; deleteBtn.disabled = true; statusSelect.value = ''; } }
    $('#bulkStatusChange')?.addEventListener('change', updateBulkActionUI);
    async function bulkChangeStatus() { const newStatus = $('#bulkStatusChange').value; if (!newStatus || selectedOrderIds.size === 0) return; const count = selectedOrderIds.size; if (confirm(`Ubah status ${count} pesanan AKTIF terpilih menjadi "${newStatus}"?`)) { showLoading(); const promises = []; selectedOrderIds.forEach(id => { const order = orders.find(o => o.id === id); if (order && order.firebaseId && !order.isArchived) { promises.push(updateOrderInFirestore(order.firebaseId, { status: newStatus })); } }); try { await Promise.all(promises); showToast(`${promises.length} status pesanan diubah.`, "success"); selectedOrderIds.clear(); updateBulkActionUI(); /* Listener will refresh table */ } catch (error) { showToast("Sebagian status gagal diubah.", "error"); } finally { hideLoading(); } } }
    $('#bulkChangeStatusBtn')?.addEventListener('click', bulkChangeStatus);
    async function bulkArchive() { if (selectedOrderIds.size === 0) return; const count = selectedOrderIds.size; if (confirm(`Arsipkan ${count} pesanan AKTIF terpilih?`)) { showLoading(); const promises = []; selectedOrderIds.forEach(id => { const order = orders.find(o => o.id === id); if (order && order.firebaseId && !order.isArchived) { promises.push(updateOrderInFirestore(order.firebaseId, { isArchived: true })); } }); try { await Promise.all(promises); showToast(`${promises.length} pesanan diarsipkan.`, "success"); selectedOrderIds.clear(); updateBulkActionUI(); } catch (error) { showToast("Sebagian pesanan gagal diarsipkan.", "error"); } finally { hideLoading(); } } }
    $('#bulkArchiveBtn')?.addEventListener('click', bulkArchive);
    async function bulkDeleteArchived() { if (selectedOrderIds.size === 0 || !$('#showArchived').checked) return; let allArchived = true; selectedOrderIds.forEach(id => { const order = orders.find(o => o.id === id); if (order && !order.isArchived) allArchived = false; }); if (!allArchived) { showToast("Hanya pesanan arsip yg bisa dihapus masal.", "error"); return; } const count = selectedOrderIds.size; if (confirm(`HAPUS PERMANEN ${count} pesanan arsip? Tidak bisa dibatalkan!`)) { showLoading(); const promises = []; selectedOrderIds.forEach(id => { const order = orders.find(o => o.id === id); if (order && order.firebaseId && order.isArchived) { promises.push(deleteOrderFromFirestore(order.firebaseId)); } }); try { await Promise.all(promises); showToast(`${promises.length} pesanan arsip dihapus.`, "success"); selectedOrderIds.clear(); updateBulkActionUI(); } catch (error) { showToast("Sebagian pesanan gagal dihapus.", "error"); } finally { hideLoading(); } } }
    $('#bulkDeleteBtn')?.addEventListener('click', bulkDeleteArchived);

    // --- DASHBOARD ---
    // (Logic remains the same, uses local `orders` cache)
    function updateDashboard() { const activeOrders = orders.filter(o => !o.isArchived); const statusCounts = { Pending: 0, 'In Progress': 0, Completed: 0, Delivered: 0 }; let totalActiveValue = 0; activeOrders.forEach(o => { if(statusCounts.hasOwnProperty(o.status)) statusCounts[o.status]++; totalActiveValue += Number(o.projectPrice) || 0; }); $('#pendingCount').textContent = statusCounts.Pending; $('#progressCount').textContent = statusCounts['In Progress']; $('#completedCount').textContent = statusCounts.Completed; $('#deliveredCount').textContent = statusCounts.Delivered; $('#totalValueActive').textContent = formatCurrency(totalActiveValue); const recentTable = $('#recentOrdersTable'); const noRecentMsg = $('#noRecentOrdersMsg'); recentTable.innerHTML = ""; const sortedForRecent = activeOrders.sort((a, b) => (b.createdTimestamp || b.id || 0) - (a.createdTimestamp || a.id || 0)); const latestFive = sortedForRecent.slice(0, 5); if (latestFive.length === 0) { noRecentMsg.style.display = 'block'; recentTable.closest('.table-container').style.display = 'none'; } else { noRecentMsg.style.display = 'none'; recentTable.closest('.table-container').style.display = ''; const fragment = document.createDocumentFragment(); latestFive.forEach(order => { const tr = document.createElement("tr"); tr.innerHTML = `<td data-label="Klien">${order.clientName}</td> <td data-label="Project">${order.projectType}</td> <td data-label="Harga" class="text-right">${formatCurrency(order.projectPrice)}</td> <td data-label="Status">${order.status}</td> <td data-label="Prioritas" class="text-center"><span class="priority-badge priority-${order.priority}">${order.priority}</span></td>`; fragment.appendChild(tr); }); recentTable.appendChild(fragment); } }

    // --- LAPORAN ---
    // (Report generation logic remains mostly the same, using the local `orders` cache)
    const reportProjectTypeFilter = $('#reportProjectTypeFilter'); const reportStartDateFilter = $('#reportStartDateFilter'); const reportEndDateFilter = $('#reportEndDateFilter'); const resetReportFiltersBtn = $('#resetReportFiltersBtn');
    function populateReportProjectTypeFilter() { const types = [...new Set(orders.map(o => o.projectType))].sort(); reportProjectTypeFilter.innerHTML = '<option value="">-- Semua Jenis Project --</option>'; types.forEach(type => { const option = document.createElement('option'); option.value = type; option.textContent = type; reportProjectTypeFilter.appendChild(option); }); }
    reportProjectTypeFilter?.addEventListener('change', generateReport); reportStartDateFilter?.addEventListener('change', generateReport); reportEndDateFilter?.addEventListener('change', generateReport);
    resetReportFiltersBtn?.addEventListener('click', () => { reportProjectTypeFilter.value = ''; reportStartDateFilter.value = ''; reportEndDateFilter.value = ''; generateReport(); });
    function getChartColors() { const isDarkMode = document.body.classList.contains('dark-mode'); const bodyStyle = getComputedStyle(document.body); return { status: { Pending: bodyStyle.getPropertyValue('--warning-color').trim(), 'In Progress': bodyStyle.getPropertyValue('--info-color').trim(), Completed: bodyStyle.getPropertyValue('--success-color').trim(), Delivered: bodyStyle.getPropertyValue('--revision-color').trim() }, projectTypes: isDarkMode ? ['#ef5350', '#42a5f5', '#66bb6a', '#ffa726', '#ab47bc', '#78909c', '#ec407a', '#26a69a', '#ffca28', '#d4e157'] : ['#dc3545', '#0d6efd', '#198754', '#ffc107', '#6f42c1', '#6c757d', '#fd7e14', '#20c997', '#ffc107', '#adb5bd'], textColor: bodyStyle.getPropertyValue('--text-color').trim(), gridColor: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }; }
    let currentClientReportData = [];
    function generateReport() {
        const reportTypeFilterValue = reportProjectTypeFilter.value; const reportStartValue = reportStartDateFilter.value; const reportEndValue = reportEndDateFilter.value;
        let filteredActiveOrders = orders.filter(o => !o.isArchived);
        if (reportTypeFilterValue) filteredActiveOrders = filteredActiveOrders.filter(o => o.projectType === reportTypeFilterValue);
        if (reportStartValue) filteredActiveOrders = filteredActiveOrders.filter(o => o.orderDate && o.orderDate >= reportStartValue);
        if (reportEndValue) filteredActiveOrders = filteredActiveOrders.filter(o => o.orderDate && o.orderDate <= reportEndValue);
        const archivedOrdersCount = orders.filter(o => o.isArchived).length; const totalActiveOrders = filteredActiveOrders.length; let totalActiveValue = 0; const statusValue = { Pending: 0, 'In Progress': 0, Completed: 0, Delivered: 0 }; const statusCounts = { Pending: 0, 'In Progress': 0, Completed: 0, Delivered: 0 }; const typeCounts = {}; const clientSummary = {}; const monthlyCounts = {};
        filteredActiveOrders.forEach(o => { totalActiveValue += Number(o.projectPrice) || 0; if (statusValue.hasOwnProperty(o.status)) statusValue[o.status] += Number(o.projectPrice) || 0; if (statusCounts.hasOwnProperty(o.status)) statusCounts[o.status]++; typeCounts[o.projectType] = (typeCounts[o.projectType] || 0) + 1; if (!clientSummary[o.clientName]) clientSummary[o.clientName] = { name: o.clientName, count: 0, value: 0 }; clientSummary[o.clientName].count++; clientSummary[o.clientName].value += Number(o.projectPrice) || 0; if (o.orderDate?.length >= 7) { const yearMonth = o.orderDate.substring(0, 7); monthlyCounts[yearMonth] = (monthlyCounts[yearMonth] || 0) + 1; } });
        $('#reportTotalActiveOrders').textContent = totalActiveOrders; $('#reportTotalArchivedOrders').textContent = archivedOrdersCount; $('#reportTotalActiveValue').textContent = formatCurrency(totalActiveValue);
        const statusCtx = $('#statusChart')?.getContext('2d'); const projectCtx = $('#projectTypeChart')?.getContext('2d'); const trendCtx = $('#trendChart')?.getContext('2d'); const reportStatusElement = $('#reportProjectStatus'); const reportTypeElement = $('#reportProjectType'); const reportValueElement = $('#reportProjectValue'); const clientTableBody = $('#clientSummaryTable tbody'); const colors = getChartColors();
        if (statusChartInstance) statusChartInstance.destroy(); if (projectTypeChartInstance) projectTypeChartInstance.destroy(); if (trendChartInstance) trendChartInstance.destroy();
        reportStatusElement.innerHTML = ''; reportTypeElement.innerHTML = ''; reportValueElement.innerHTML = ''; clientTableBody.innerHTML = ''; const emptyChartMsg = '<p class="empty-message" style="padding: 20px 0;">Tidak ada data aktif sesuai filter.</p>';
        if (totalActiveOrders === 0 || !statusCtx || !projectCtx || !trendCtx) { if (reportStatusElement) reportStatusElement.innerHTML = emptyChartMsg; if (reportTypeElement) reportTypeElement.innerHTML = emptyChartMsg; if (reportValueElement) reportValueElement.innerHTML = emptyChartMsg; if (clientTableBody) clientTableBody.innerHTML = `<tr><td colspan="3">${emptyChartMsg}</td></tr>`; if(statusCtx) statusCtx.canvas.style.display = 'none'; if(projectCtx) projectCtx.canvas.style.display = 'none'; if(trendCtx) trendCtx.canvas.style.display = 'none'; return; }
        statusCtx.canvas.style.display = 'block'; projectCtx.canvas.style.display = 'block'; trendCtx.canvas.style.display = 'block';
        statusChartInstance = new Chart(statusCtx, { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ label: 'Status (Jumlah)', data: Object.values(statusCounts), backgroundColor: Object.keys(statusCounts).map(label => colors.status[label] || '#cccccc'), borderColor: colors.gridColor, borderWidth: 1, hoverOffset: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: colors.textColor, padding: 15 } }, tooltip: { callbacks: { label: ctx => ` ${ctx.label}: ${ctx.raw}` } } } } });
        const sortedTypes = Object.entries(typeCounts).sort(([,a],[,b]) => b-a); projectTypeChartInstance = new Chart(projectCtx, { type: 'bar', data: { labels: sortedTypes.map(([label]) => label), datasets: [{ label: 'Jumlah per Tipe', data: sortedTypes.map(([,data]) => data), backgroundColor: sortedTypes.map((_, index) => colors.projectTypes[index % colors.projectTypes.length]), borderColor: sortedTypes.map((_, index) => colors.projectTypes[index % colors.projectTypes.length]), borderWidth: 1, borderRadius: 3 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { ticks: { color: colors.textColor, precision: 0 }, grid: { color: colors.gridColor, drawBorder: false } }, y: { ticks: { color: colors.textColor }, grid: { display: false, drawBorder: false } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ` ${ctx.raw} order` } } } } });
        let valueReportHtml = '<ul>'; Object.keys(statusValue).forEach(status => { valueReportHtml += `<li><span class="status-color-dot" style="background-color: ${colors.status[status] || '#ccc'};"></span> ${status}: <strong>${formatCurrency(statusValue[status])}</strong></li>`; }); valueReportHtml += `<li class="total-value"><strong>Total Nilai Aktif:</strong> <strong>${formatCurrency(totalActiveValue)}</strong></li></ul>`; reportValueElement.innerHTML = valueReportHtml;
        currentClientReportData = Object.values(clientSummary); sortClientTable(clientReportSort.column, clientReportSort.direction); // Use Object.values here
        const sortedMonths = Object.keys(monthlyCounts).sort(); const trendLabels = sortedMonths; const trendData = sortedMonths.map(month => monthlyCounts[month]);
        trendChartInstance = new Chart(trendCtx, { type: 'line', data: { labels: trendLabels, datasets: [{ label: 'Jumlah Order Masuk', data: trendData, borderColor: colors.accentColor || '#007bff', backgroundColor: colors.accentColor ? colors.accentColor + '33' : '#007bff33', tension: 0.1, fill: true, pointBackgroundColor: colors.accentColor || '#007bff', pointRadius: 4, pointHoverRadius: 6, }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Bulan Order', color: colors.textColor }, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }, y: { title: { display: true, text: 'Jumlah Order', color: colors.textColor }, ticks: { color: colors.textColor, precision: 0 }, grid: { color: colors.gridColor } } }, plugins: { legend: { display: false }, tooltip: { callbacks: { title: ctx => ctx[0].label, label: ctx => ` ${ctx.raw} order` } } } } });
    }
    function sortClientTable(columnIndex, direction = null) {
        const clientTableBody = $('#clientSummaryTable tbody'); const dir = direction ? direction : (clientReportSort.column === columnIndex ? (clientReportSort.direction === 'asc' ? 'desc' : 'asc') : 'desc');
        clientReportSort = { column: columnIndex, direction: dir };
        currentClientReportData.sort((a, b) => { // Sort the array of client objects
            let valA, valB;
            if (columnIndex === 0) { valA = a.name?.toLowerCase() || ''; valB = b.name?.toLowerCase() || ''; }
            else if (columnIndex === 1) { valA = a.count || 0; valB = b.count || 0; }
            else { valA = a.value || 0; valB = b.value || 0; }
            const sortDir = dir === 'asc' ? 1 : -1;
            if (valA < valB) return -1 * sortDir; if (valA > valB) return 1 * sortDir;
            // Secondary sort by name if counts/values are equal
            const nameA = a.name?.toLowerCase() || ''; const nameB = b.name?.toLowerCase() || '';
            if (nameA < nameB) return -1; if (nameA > nameB) return 1; return 0;
        });
        clientTableBody.innerHTML = ''; const fragment = document.createDocumentFragment();
        currentClientReportData.slice(0, 10).forEach(data => { // Iterate over sorted objects
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${data.name}</td><td class="text-center">${data.count}</td><td class="text-right">${formatCurrency(data.value)}</td>`;
            fragment.appendChild(tr);
        }); clientTableBody.appendChild(fragment);
    }

    // --- EXPORT TO CSV ---
    function exportToCSV() { const showArchived = $('#showArchived').checked; const ordersToExport = orders.filter(order => order.isArchived === showArchived); if (ordersToExport.length === 0) { showToast(`Tidak ada data ${showArchived ? 'arsip' : 'aktif'} untuk diekspor.`, "info"); return; } const headers = ['ID', 'Nama Klien', 'Kontak Klien', 'Jenis Project', 'Harga', 'Tanggal Order', 'Deadline', 'Prioritas', 'Status', 'Tags', 'Link Lampiran', 'Catatan']; const rows = ordersToExport.map(order => [ order.id, `"${(order.clientName || '').replace(/"/g, '""')}"`, `"${(order.clientContact || '').replace(/"/g, '""')}"`, order.projectType, order.projectPrice || 0, order.orderDate, order.deadline, order.priority, order.status, `"${(order.projectTags || []).join(', ').replace(/"/g, '""')}"`, `"${(order.attachmentLink || '').replace(/"/g, '""')}"`, `"${(order.notes || '').replace(/"/g, '""')}"` ]); let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + rows.map(e => e.join(",")).join("\n"); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); const timestamp = new Date().toISOString().slice(0, 10); const fileType = showArchived ? 'arsip' : 'aktif'; link.setAttribute("download", `project_klien_${fileType}_${timestamp}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); showToast(`Data ${fileType} diekspor ke CSV.`, "success"); }

    // --- UI & NAVIGATION ---
    function toggleMenu() { $('#navMenu').classList.toggle('show'); }
    function setActiveLink(activeSectionId) { $$('#navMenu a').forEach(link => { link.classList.toggle('active-link', link.getAttribute('data-section') === activeSectionId); }); }
    function showSection(sectionId, clickedLink = null) { $('#navMenu').classList.remove('show'); $$('main section').forEach(sec => sec.classList.remove('active')); const activeSection = $(`#${sectionId}`); if (activeSection) { activeSection.classList.add('active'); setActiveLink(sectionId); $('main').scrollTo({ top: 0, behavior: 'auto' }); } else { console.warn(`Section ${sectionId} not found.`); $('#dashboardSection').classList.add('active'); setActiveLink('dashboardSection'); } switch (sectionId) { case "dashboardSection": updateDashboard(); break; case "reportSection": generateReport(); break; case "listSection": applyFilterAndSort(); break; case "inputSection": $('#orderForm').reset(); $$('#orderForm .error-message').forEach(el => el.style.display = 'none'); $$('#orderForm .invalid').forEach(el => el.classList.remove('invalid')); $('#clientName').focus(); break; } }

    // --- INITIAL LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        // Load initial settings (like itemsPerPage) *before* starting Firestore listener
        itemsPerPage = parseInt(localStorage.getItem('itemsPerPage') || '15', 10);
        $('#itemsPerPageSelect').value = itemsPerPage;

        if (db) { // Only load data if Firebase initialized correctly
             loadDataFromFirestore(); // Start listening to Firestore
         } else {
             // Handle case where Firebase didn't initialize
             showToast("Database tidak dapat diakses. Aplikasi mungkin tidak berfungsi penuh.", "error", 10000);
             // Show empty state or disable functionality
             updateDashboard(); // Show 0 counts
             applyFilterAndSort(); // Show empty table message
         }

        showSection('dashboardSection'); // Show dashboard initially
        // applyFilterAndSort() will be called by the Firestore listener once data arrives
    });

    </script>
</body>
</html>
